function [output,CRC16] = CRC16_MODBUS(puchMsg)
% [output,CRC16] = CRC16(puchMsg)
% 进行CRC16 编码，。
% 输入：puchMsg 为输入序列，usDataLen为序列长度。
% 输出：CRC16 为两个字节的校验位，output 为带校验位的输出。
% 初始状态 FFFF。

    %% CRC 查询表
    auchCRCHi=hex2dec([...
    '00';'C1';'81';'40';'01';'C0';'80';'41';'01';'C0';'80';'41';'00';'C1';'81';...
    '40';'01';'C0';'80';'41';'00';'C1';'81';'40';'00';'C1';'81';'40';'01';'C0';...
    '80';'41';'01';'C0';'80';'41';'00';'C1';'81';'40';'00';'C1';'81';'40';'01';...
    'C0';'80';'41';'00';'C1';'81';'40';'01';'C0';'80';'41';'01';'C0';'80';'41';...
    '00';'C1';'81';'40';'01';'C0';'80';'41';'00';'C1';'81';'40';'00';'C1';'81';...
    '40';'01';'C0';'80';'41';'00';'C1';'81';'40';'01';'C0';'80';'41';'01';'C0';...
    '80';'41';'00';'C1';'81';'40';'00';'C1';'81';'40';'01';'C0';'80';'41';'01';...
    'C0';'80';'41';'00';'C1';'81';'40';'01';'C0';'80';'41';'00';'C1';'81';'40';...
    '00';'C1';'81';'40';'01';'C0';'80';'41';'01';'C0';'80';'41';'00';'C1';'81';...
    '40';'00';'C1';'81';'40';'01';'C0';'80';'41';'00';'C1';'81';'40';'01';'C0';...
    '80';'41';'01';'C0';'80';'41';'00';'C1';'81';'40';'00';'C1';'81';'40';'01';...
    'C0';'80';'41';'01';'C0';'80';'41';'00';'C1';'81';'40';'01';'C0';'80';'41';...
    '00';'C1';'81';'40';'00';'C1';'81';'40';'01';'C0';'80';'41';'00';'C1';'81';...
    '40';'01';'C0';'80';'41';'01';'C0';'80';'41';'00';'C1';'81';'40';'01';'C0';...
    '80';'41';'00';'C1';'81';'40';'00';'C1';'81';'40';'01';'C0';'80';'41';'01';...
    'C0';'80';'41';'00';'C1';'81';'40';'00';'C1';'81';'40';'01';'C0';'80';'41';...
    '00';'C1';'81';'40';'01';'C0';'80';'41';'01';'C0';'80';'41';'00';'C1';'81';...
    '40']);

     auchCRCLo = hex2dec([...
    '00';'C0';'C1';'01';'C3';'03';'02';'C2';'C6';'06';'07';'C7';'05';'C5';'C4';...
    '04';'CC';'0C';'0D';'CD';'0F';'CF';'CE';'0E';'0A';'CA';'CB';'0B';'C9';'09';...
    '08';'C8';'D8';'18';'19';'D9';'1B';'DB';'DA';'1A';'1E';'DE';'DF';'1F';'DD';...
    '1D';'1C';'DC';'14';'D4';'D5';'15';'D7';'17';'16';'D6';'D2';'12';'13';'D3';...
    '11';'D1';'D0';'10';'F0';'30';'31';'F1';'33';'F3';'F2';'32';'36';'F6';'F7';...
    '37';'F5';'35';'34';'F4';'3C';'FC';'FD';'3D';'FF';'3F';'3E';'FE';'FA';'3A';...
    '3B';'FB';'39';'F9';'F8';'38';'28';'E8';'E9';'29';'EB';'2B';'2A';'EA';'EE';...
    '2E';'2F';'EF';'2D';'ED';'EC';'2C';'E4';'24';'25';'E5';'27';'E7';'E6';'26';...
    '22';'E2';'E3';'23';'E1';'21';'20';'E0';'A0';'60';'61';'A1';'63';'A3';'A2';...
    '62';'66';'A6';'A7';'67';'A5';'65';'64';'A4';'6C';'AC';'AD';'6D';'AF';'6F';...
    '6E';'AE';'AA';'6A';'6B';'AB';'69';'A9';'A8';'68';'78';'B8';'B9';'79';'BB';...
    '7B';'7A';'BA';'BE';'7E';'7F';'BF';'7D';'BD';'BC';'7C';'B4';'74';'75';'B5';...
    '77';'B7';'B6';'76';'72';'B2';'B3';'73';'B1';'71';'70';'B0';'50';'90';'91';...
    '51';'93';'53';'52';'92';'96';'56';'57';'97';'55';'95';'94';'54';'9C';'5C';...
    '5D';'9D';'5F';'9F';'9E';'5E';'5A';'9A';'9B';'5B';'99';'59';'58';'98';'88';...
    '48';'49';'89';'4B';'8B';'8A';'4A';'4E';'8E';'8F';'4F';'8D';'4D';'4C';'8C';...
    '44';'84';'85';'45';'87';'47';'46';'86';'82';'42';'43';'83';'41';'81';'80';...
    '40']);

    %% 初始状态
    uchCRCHi = hex2dec('FF');       % CRC 的高字节初始化%
    uchCRCLo = hex2dec('FF');       % CRC 的低字节初始化%
    CRC16 = ['FF';'FF'];
    % uIndex = 0; % CRC 查询表索引%

    usDataLen = length(puchMsg);
    %% 编码及输出
    for i = 1:usDataLen  % 完成整个报文缓冲区%
        uIndex = bitxor(uchCRCLo,puchMsg(i)); % 计算CRC %
        uchCRCLo = bitxor(uchCRCHi,auchCRCHi(uIndex+1));
        uchCRCHi = auchCRCLo(uIndex+1);
    end
    tmp = dec2hex([uchCRCHi;uchCRCLo]);   % 低位在前，高位在后
%     CRC16(1,:) = sprintf('%02X',uchCRCHi);   % 根据回传的数据，应该是高位在前，低位在后
%     CRC16(2,:) = sprintf('%02X',uchCRCLo);
    if(length(tmp(1,:))==1)
        CRC16(1,:) = ['0',tmp(1,:)];
    elseif(length(tmp(2,:))==1)
        CRC16(2,:) = ['0',tmp(2,:)];
    else
        CRC16 = tmp;
    end
    output = [dec2hex(puchMsg);CRC16];
end


